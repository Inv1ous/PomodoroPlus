name: Build Signed Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to publish/update (example: v1.2.0)"
        required: true
        type: string

jobs:
  build-and-publish:
    runs-on: macos-14
    permissions:
      contents: write
    env:
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_DEVELOPER_ID_CERT_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_CERT_P12_BASE64 }}
      APPLE_DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERT_PASSWORD }}
      APPLE_KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
      APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
      APPLE_NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
      APPLE_NOTARY_API_KEY_BASE64: ${{ secrets.APPLE_NOTARY_API_KEY_BASE64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          set -euo pipefail
          required=(
            APPLE_TEAM_ID
            APPLE_DEVELOPER_ID_CERT_P12_BASE64
            APPLE_DEVELOPER_ID_CERT_PASSWORD
            APPLE_KEYCHAIN_PASSWORD
            APPLE_NOTARY_KEY_ID
            APPLE_NOTARY_ISSUER_ID
            APPLE_NOTARY_API_KEY_BASE64
          )
          for key in "${required[@]}"; do
            if [[ -z "${!key:-}" ]]; then
              echo "Missing required secret: $key" >&2
              exit 1
            fi
          done

      - name: Prepare signing keychain and notary key
        run: |
          set -euo pipefail

          CERT_PATH="$RUNNER_TEMP/developer_id.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/pomodoroplus-signing.keychain-db"
          NOTARY_KEY_PATH="$RUNNER_TEMP/AuthKey_${APPLE_NOTARY_KEY_ID}.p8"

          echo "$APPLE_DEVELOPER_ID_CERT_P12_BASE64" | base64 --decode > "$CERT_PATH"
          echo "$APPLE_NOTARY_API_KEY_BASE64" | base64 --decode > "$NOTARY_KEY_PATH"

          security create-keychain -p "$APPLE_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$APPLE_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$APPLE_DEVELOPER_ID_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/xcodebuild
          security set-key-partition-list -S apple-tool:,apple: -s -k "$APPLE_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"

          echo "APPLE_NOTARY_API_KEY_FILE=$NOTARY_KEY_PATH" >> "$GITHUB_ENV"

      - name: Build, notarize, and verify
        id: build
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name || inputs.tag }}
        run: |
          set -euo pipefail
          ./scripts/release/build_signed_release.sh
          ARTIFACT_PATH="$(cat dist/release_artifact_path.txt)"
          echo "artifact_path=$ARTIFACT_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload release artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name || inputs.tag }}
          files: ${{ steps.build.outputs.artifact_path }}
          overwrite_files: true
          fail_on_unmatched_files: true
